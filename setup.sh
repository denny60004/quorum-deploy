#!/bin/bash

#### Configuration options #############################################
. ip.cfg

image=denny60004/quorum-crux:latest
GETH='/usr/local/bin/geth'
BOOTNODE='/usr/local/bin/bootnode'
CONSTELLATION='/usr/local/bin/crux'

########################################################################

nnodes=${#ips[@]}

if [[ $nnodes < 2 ]]
then
    echo "ERROR: There must be more than one node IP address."
    exit 1
fi

./cleanup.sh

uid=`id -u`
gid=`id -g`
pwd=`pwd`

#### Create directories for each node's configuration ##################
echo '[1] ~~~> Configuring for '$nnodes' nodes.'

n=1
for ip in ${ips[*]}
do
    qd=qdata_$n
    mkdir -p $qd/{logs,constellation/keys}
    mkdir -p $qd/dd/geth

    let n++
done


#### Make static-nodes.json and store keys #############################
echo
echo '[2] ~~~> Creating Enodes and static-nodes.json.'

echo "[" > static-nodes.json
n=1
for ip in ${ips[*]}
do
    qd=qdata_$n
    nodekey_file='/qdata/dd/geth/nodekey'

    # Generate the node's Enode and key
    enode=`docker run \
      -u $uid:$gid \
      -v $pwd/$qd:/qdata \
      --rm \
      $image \
      /bin/bash -c "$BOOTNODE -genkey $nodekey_file; \
      $BOOTNODE -nodekey $nodekey_file -writeaddress"`

    # Add the enode to static-nodes.json
    enode_url='enode://'$enode'@'$ip':30303?discport=0&raftport=23000'
    sep=`[[ $n < $nnodes ]] && echo ","`
    echo ' "'$enode_url'"'$sep >> static-nodes.json

    let n++
done
echo "]" >> static-nodes.json


#### Create accounts, keys and genesis.json file #######################
echo
echo '[3] ~~~> Creating Ether accounts and genesis.json.'

cat > genesis.json <<EOF
{
  "alloc": {
    "0x0000000000000000000000000000000000000030": {
      "code": "0x60806040526004361061006d576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680633072b1b2146100725780636168d293146102395780637f11a8ed14610264578063aeffe3b714610531578063deb043c6146106f8575b600080fd5b34801561007e57600080fd5b50610237600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506109be565b005b34801561024557600080fd5b5061024e610f51565b6040518082815260200191505060405180910390f35b34801561027057600080fd5b50610293600480360381019080803561ffff169060200190929190505050610f5e565b6040518080602001806020018060200180602001806020018060200188815260200187810387528e818151815260200191508051906020019080838360005b838110156102ed5780820151818401526020810190506102d2565b50505050905090810190601f16801561031a5780820380516001836020036101000a031916815260200191505b5087810386528d818151815260200191508051906020019080838360005b83811015610353578082015181840152602081019050610338565b50505050905090810190601f1680156103805780820380516001836020036101000a031916815260200191505b5087810385528c818151815260200191508051906020019080838360005b838110156103b957808201518184015260208101905061039e565b50505050905090810190601f1680156103e65780820380516001836020036101000a031916815260200191505b5087810384528b818151815260200191508051906020019080838360005b8381101561041f578082015181840152602081019050610404565b50505050905090810190601f16801561044c5780820380516001836020036101000a031916815260200191505b5087810383528a818151815260200191508051906020019080838360005b8381101561048557808201518184015260208101905061046a565b50505050905090810190601f1680156104b25780820380516001836020036101000a031916815260200191505b50878103825289818151815260200191508051906020019080838360005b838110156104eb5780820151818401526020810190506104d0565b50505050905090810190601f1680156105185780820380516001836020036101000a031916815260200191505b509d505050505050505050505050505060405180910390f35b34801561053d57600080fd5b506106f6600480360381019080803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509192919290803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091929192905050506114db565b005b34801561070457600080fd5b50610727600480360381019080803561ffff169060200190929190505050611a2f565b6040518080602001806020018060200180602001806020018060200187810387528d818151815260200191508051906020019080838360005b8381101561077b578082015181840152602081019050610760565b50505050905090810190601f1680156107a85780820380516001836020036101000a031916815260200191505b5087810386528c818151815260200191508051906020019080838360005b838110156107e15780820151818401526020810190506107c6565b50505050905090810190601f16801561080e5780820380516001836020036101000a031916815260200191505b5087810385528b818151815260200191508051906020019080838360005b8381101561084757808201518184015260208101905061082c565b50505050905090810190601f1680156108745780820380516001836020036101000a031916815260200191505b5087810384528a818151815260200191508051906020019080838360005b838110156108ad578082015181840152602081019050610892565b50505050905090810190601f1680156108da5780820380516001836020036101000a031916815260200191505b50878103835289818151815260200191508051906020019080838360005b838110156109135780820151818401526020810190506108f8565b50505050905090810190601f1680156109405780820380516001836020036101000a031916815260200191505b50878103825288818151815260200191508051906020019080838360005b8381101561097957808201518184015260208101905061095e565b50505050905090810190601f1680156109a65780820380516001836020036101000a031916815260200191505b509c5050505050505050505050505060405180910390f35b836001846040518082805190602001908083835b6020831015156109f757805182526020820191506020810190506020830392506109d2565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206002019080519060200190610a40929190611f9e565b50856001846040518082805190602001908083835b602083101515610a7a5780518252602082019150602081019050602083039250610a55565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000019080519060200190610ac3929190611f9e565b50846001846040518082805190602001908083835b602083101515610afd5780518252602082019150602081019050602083039250610ad8565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001019080519060200190610b46929190611f9e565b50816001846040518082805190602001908083835b602083101515610b805780518252602082019150602081019050602083039250610b5b565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206004019080519060200190610bc9929190611f9e565b50806001846040518082805190602001908083835b602083101515610c035780518252602082019150602081019050602083039250610bde565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206005019080519060200190610c4c929190611f9e565b506002839080600181540180825580915050906001820390600052602060002001600090919290919091509080519060200190610c8a929190611f9e565b50507f02909f0e17ce8f686a5301248241233e79b4d7879283285063f7441c3b7467808686868686866040518080602001806020018060200180602001806020018060200187810387528d818151815260200191508051906020019080838360005b83811015610d07578082015181840152602081019050610cec565b50505050905090810190601f168015610d345780820380516001836020036101000a031916815260200191505b5087810386528c818151815260200191508051906020019080838360005b83811015610d6d578082015181840152602081019050610d52565b50505050905090810190601f168015610d9a5780820380516001836020036101000a031916815260200191505b5087810385528b818151815260200191508051906020019080838360005b83811015610dd3578082015181840152602081019050610db8565b50505050905090810190601f168015610e005780820380516001836020036101000a031916815260200191505b5087810384528a818151815260200191508051906020019080838360005b83811015610e39578082015181840152602081019050610e1e565b50505050905090810190601f168015610e665780820380516001836020036101000a031916815260200191505b50878103835289818151815260200191508051906020019080838360005b83811015610e9f578082015181840152602081019050610e84565b50505050905090810190601f168015610ecc5780820380516001836020036101000a031916815260200191505b50878103825288818151815260200191508051906020019080838360005b83811015610f05578082015181840152602081019050610eea565b50505050905090810190601f168015610f325780820380516001836020036101000a031916815260200191505b509c5050505050505050505050505060405180910390a1505050505050565b6000600280549050905090565b6060806060806060806000610f7161201e565b600160028a61ffff16815481101515610f8657fe5b906000526020600020016040518082805460018160011615610100020316600290048015610feb5780601f10610fc9576101008083540402835291820191610feb565b820191906000526020600020905b815481529060010190602001808311610fd7575b5050915050908152602001604051809103902060c06040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156110a35780601f10611078576101008083540402835291602001916110a3565b820191906000526020600020905b81548152906001019060200180831161108657829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156111455780601f1061111a57610100808354040283529160200191611145565b820191906000526020600020905b81548152906001019060200180831161112857829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156111e75780601f106111bc576101008083540402835291602001916111e7565b820191906000526020600020905b8154815290600101906020018083116111ca57829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156112895780601f1061125e57610100808354040283529160200191611289565b820191906000526020600020905b81548152906001019060200180831161126c57829003601f168201915b50505050508152602001600482018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561132b5780601f106113005761010080835404028352916020019161132b565b820191906000526020600020905b81548152906001019060200180831161130e57829003601f168201915b50505050508152602001600582018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156113cd5780601f106113a2576101008083540402835291602001916113cd565b820191906000526020600020905b8154815290600101906020018083116113b057829003601f168201915b5050505050815250509050806000015181602001518260400151836080015160028d61ffff168154811015156113ff57fe5b906000526020600020018560a001518e869650859550849450839350828054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156114b05780601f10611485576101008083540402835291602001916114b0565b820191906000526020600020905b81548152906001019060200180831161149357829003601f168201915b505050505092508191508061ffff169050975097509750975097509750975050919395979092949650565b836001846040518082805190602001908083835b60208310151561151457805182526020820191506020810190506020830392506114ef565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020600201908051906020019061155d929190611f9e565b50856001846040518082805190602001908083835b6020831015156115975780518252602082019150602081019050602083039250611572565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060000190805190602001906115e0929190611f9e565b50846001846040518082805190602001908083835b60208310151561161a57805182526020820191506020810190506020830392506115f5565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206001019080519060200190611663929190611f9e565b50816001846040518082805190602001908083835b60208310151561169d5780518252602082019150602081019050602083039250611678565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060040190805190602001906116e6929190611f9e565b50806001846040518082805190602001908083835b60208310151561172057805182526020820191506020810190506020830392506116fb565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206005019080519060200190611769929190611f9e565b507f02909f0e17ce8f686a5301248241233e79b4d7879283285063f7441c3b7467808686868686866040518080602001806020018060200180602001806020018060200187810387528d818151815260200191508051906020019080838360005b838110156117e55780820151818401526020810190506117ca565b50505050905090810190601f1680156118125780820380516001836020036101000a031916815260200191505b5087810386528c818151815260200191508051906020019080838360005b8381101561184b578082015181840152602081019050611830565b50505050905090810190601f1680156118785780820380516001836020036101000a031916815260200191505b5087810385528b818151815260200191508051906020019080838360005b838110156118b1578082015181840152602081019050611896565b50505050905090810190601f1680156118de5780820380516001836020036101000a031916815260200191505b5087810384528a818151815260200191508051906020019080838360005b838110156119175780820151818401526020810190506118fc565b50505050905090810190601f1680156119445780820380516001836020036101000a031916815260200191505b50878103835289818151815260200191508051906020019080838360005b8381101561197d578082015181840152602081019050611962565b50505050905090810190601f1680156119aa5780820380516001836020036101000a031916815260200191505b50878103825288818151815260200191508051906020019080838360005b838110156119e35780820151818401526020810190506119c8565b50505050905090810190601f168015611a105780820380516001836020036101000a031916815260200191505b509c5050505050505050505050505060405180910390a1505050505050565b606080606080606080611a4061201e565b600160028961ffff16815481101515611a5557fe5b906000526020600020016040518082805460018160011615610100020316600290048015611aba5780601f10611a98576101008083540402835291820191611aba565b820191906000526020600020905b815481529060010190602001808311611aa6575b5050915050908152602001604051809103902060c06040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611b725780601f10611b4757610100808354040283529160200191611b72565b820191906000526020600020905b815481529060010190602001808311611b5557829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611c145780601f10611be957610100808354040283529160200191611c14565b820191906000526020600020905b815481529060010190602001808311611bf757829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611cb65780601f10611c8b57610100808354040283529160200191611cb6565b820191906000526020600020905b815481529060010190602001808311611c9957829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611d585780601f10611d2d57610100808354040283529160200191611d58565b820191906000526020600020905b815481529060010190602001808311611d3b57829003601f168201915b50505050508152602001600482018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611dfa5780601f10611dcf57610100808354040283529160200191611dfa565b820191906000526020600020905b815481529060010190602001808311611ddd57829003601f168201915b50505050508152602001600582018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611e9c5780601f10611e7157610100808354040283529160200191611e9c565b820191906000526020600020905b815481529060010190602001808311611e7f57829003601f168201915b5050505050815250509050806000015181602001518260400151836080015160028c61ffff16815481101515611ece57fe5b906000526020600020018560a00151859550849450839350829250818054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015611f7e5780601f10611f5357610100808354040283529160200191611f7e565b820191906000526020600020905b815481529060010190602001808311611f6157829003601f168201915b505050505091508090509650965096509650965096505091939550919395565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10611fdf57805160ff191683800117855561200d565b8280016001018555821561200d579182015b8281111561200c578251825591602001919060010190611ff1565b5b50905061201a9190612055565b5090565b60c0604051908101604052806060815260200160608152602001606081526020016060815260200160608152602001606081525090565b61207791905b8082111561207357600081600090555060010161205b565b5090565b905600a165627a7a7230582010868d4732376627360a6933541c3f3ea9b2fb7479824b10d8d49dcceb57c2ca0029",
      "balance":"0"
    },
EOF

n=1
for ip in ${ips[*]}
do
  qd=qdata_$n

  # Generate an Ether account for the node
  touch $qd/passwords.txt
  account=`docker run \
    -u $uid:$gid \
    -v $pwd/$qd:/qdata \
    --rm \
    $image \
    $GETH \
    --datadir=/qdata/dd \
    --password /qdata/passwords.txt \
    account new | cut -c 11-50`

  # Add the account to the genesis block so it has some Ether at start-up
  sep=`[[ $n < $nnodes ]] && echo ","`
  cat >> genesis.json <<EOF
    "${account}": {
      "balance": "1000000000000000000000000000"
    }${sep}
EOF

  let n++
done

cat >> genesis.json <<EOF
  },
  "coinbase": "0x0000000000000000000000000000000000000000",
  "config": {
    "homesteadBlock": 0,
    "chainId": 10,
    "eip155Block": null,
    "eip158Block": null,
    "isQuorum": true
  },
  "difficulty": "0x0",
  "extraData": "0x0000000000000000000000000000000000000000000000000000000000000000",
  "gasLimit": "0xE0000000",
  "mixhash": "0x00000000000000000000000000000000000000647572616c65787365646c6578",
  "nonce": "0x0",
  "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
  "timestamp": "0x00"
}
EOF


#### Make node list for tm.conf ########################################

nodelist=
n=1
for ip in ${ips[*]}
do
    sep=`[[ $ip != ${ips[0]} ]] && echo ","`
    nodelist=${nodelist}${sep}"http://${ip}:9000/"
    let n++
done


#### Complete each node's configuration ################################
echo
echo '[4] ~~~> Creating Quorum keys and finishing configuration.'

n=1
for ip in ${ips[*]}
do
  qd=qdata_$n

  cat templates/tm.conf \
    | sed s/_NODEIP_/${ips[$((n-1))]}/g \
    | sed s%_NODELIST_%$nodelist%g \
    > $qd/tm.conf

  cp genesis.json $qd/genesis.json
  cp static-nodes.json $qd/dd/static-nodes.json

  # Generate Quorum-related keys (used by Constellation)
  docker run \
    -u $uid:$gid \
    -v $pwd/$qd:/qdata \
    --rm \
    --workdir=/qdata/constellation/keys \
    $image \
    $CONSTELLATION \
    --generate-keys=tm
  echo 'Node '$n' public key: '`cat $qd/constellation/keys/tm.pub`

  cp templates/start.sh $qd/start.sh
  chmod 755 $qd/start.sh

  let n++
done
rm -rf genesis.json static-nodes.json


#### Create pre-populated contracts ####################################
echo
echo '[5] ~~~> Generating sample contract scripts.'

mkdir scripts

# Private contract - insert Node 2 as the recipient
cat templates/contract_pri.js \
  | sed s:_NODEKEY_:`cat qdata_2/constellation/keys/tm.pub`:g \
  > scripts/contract_pri.js

# Public contract - no change required
cp templates/contract_pub.js scripts/
cp templates/contract_act.js scripts/

### Setup init script ################################################
./geninit.sh

#### Create the k8s yaml file ####################################
echo
echo '[6] ~~~> Creating kubernetes definition yaml.'

n=1
port=31701
for ip in ${ips[*]}
do
  qd=qdata_$n

  pad='          '
  cat $qd/init.sh \
    | sed "s/^/$pad/" \
    | sed '/^[[:space:]]*$/d' \
    > init.sh
  echo "$pad""bash /qdata/start.sh" >> init.sh

  pad='    '
  cat $qd/tm.conf \
    | sed "s/^/$pad/" \
    | sed '/^[[:space:]]*$/d' \
    > tm.conf
  cat templates/crux_config.yaml \
    | sed "s;_NODE_ID_;$n;g" \
    | sed '/_CRUX_/r tm.conf' \
    | sed '/_CRUX_/d' \
    >> crux_config.yaml

  tmpub=$(<$qd/constellation/keys/tm.pub)
  cat templates/setup.conf \
    | sed "s;_NODE_ID_;$n;g" \
    | sed "s;_NODE_IP_;$ip;g" \
    | sed "s;_TM_PUB_;$tmpub;g" \
    > setup$n.conf
  cat setup$n.conf \
    | sed "s/^/$pad/" \
    | sed '/^[[:space:]]*$/d' \
    > setup.conf
  cat templates/backend_config.yaml \
    | sed "s;_NODE_ID_;$n;g" \
    | sed '/_BACKEND_/r setup.conf' \
    | sed '/_BACKEND_/d' \
    >> backend_config.yaml

  cat $qd/constellation/keys/tm.pub \
    | base64 \
    | sed "s/^/$pad/" \
    | sed '/^[[:space:]]*$/d' \
    > tm.pub
  cat $qd/constellation/keys/tm.key \
    | base64 \
    | sed "s/^/$pad/" \
    | sed '/^[[:space:]]*$/d' \
    > tm.key
  account=`ls $qd/dd/keystore | head -n 1`
  cat $qd/dd/keystore/$account \
    | base64 \
    | sed "s/^/$pad/" \
    | sed '/^[[:space:]]*$/d' \
    > account.key
  cat $qd/passwords.txt \
    | base64 \
    | sed "s/^/$pad/" \
    | sed '/^[[:space:]]*$/d' \
    > passwords.txt
  cat templates/node_secret.yaml \
    | sed "s;_NODE_ID_;$n;g" \
    | sed '/_TM_PUB_/r tm.pub' \
    | sed '/_TM_PUB_/d' \
    | sed '/_TM_KEY_/r tm.key' \
    | sed '/_TM_KEY_/d' \
    | sed '/_ACCOUNT_KEY_/r account.key' \
    | sed '/_ACCOUNT_KEY_/d' \
    | sed '/_PASSWORD_/r password.txt' \
    | sed '/_PASSWORD_/d' \
    >> node_secret.yaml

  cat templates/consortium.yaml \
    | sed "s;_NODE_ID_;$n;g" \
    | sed "s;_NODE_IP_;$ip;g" \
    | sed "s;_NODE_PORT_;$port;g" \
    | sed "s;_QUORUM_IMAGE_;$quorum_image;g" \
    | sed "s;_EXPLORER_IMAGE_;$backend_image;g" \
    | sed "s;_IMAGE_PULL_POLICY_;$image_pull_policy;g" \
    | sed '/_NODE_SCRIPT_/r init.sh' \
    | sed '/_NODE_SCRIPT_/d' \
    >> consortium.yaml

  rm init.sh tm.conf tm.pub tm.key account.key passwords.txt setup.conf setup$n.conf
  let n++
  let port++
done

# create config map
pad='    '
cat $qd/dd/static-nodes.json \
    | sed "s/^/$pad/" \
    | sed '/^[[:space:]]*$/d' \
    > static-nodes.json
cat $qd/genesis.json \
    | sed "s/^/$pad/" \
    | sed '/^[[:space:]]*$/d' \
    > genesis.json
cat $qd/start.sh \
    | sed "s/^/$pad/" \
    | sed '/^[[:space:]]*$/d' \
    > start_node.sh

cat templates/quorum_config.yaml \
  | sed '/_STATIC_NODES_/r static-nodes.json' \
  | sed '/_STATIC_NODES_/d' \
  | sed '/_GENESIS_/r genesis.json' \
  | sed '/_GENESIS_/d' \
  | sed '/_START_/r start_node.sh' \
  | sed '/_START_/d' \
  >> quorum_config.yaml

rm static-nodes.json genesis.json start_node.sh

cat >> consortium.yaml <<EOF
apiVersion: v1
kind: Service
metadata:
  annotations:
    app: consortiumchain
    version: '1'
  creationTimestamp: null
  labels:
    name: node-endpoint
  name: node-endpoint
spec:
  type: LoadBalancer
  clusterIP: $node_endpoint_ip
  ports:
  - name: rpc
    port: 8545
    targetPort: 8545
  - name: backend
    port: 22004
    targetPort: 22004
  selector:
    app: consortiumchain
status:
  loadBalancer: {}
EOF

